name: CI - Main Branch Protection

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black pylint
        
    - name: Run Black (Code Formatter Check)
      run: |
        black --check app.py
        
    - name: Run Flake8 (Linting)
      run: |
        flake8 app.py --max-line-length=120 --extend-ignore=E203,W503
        
    - name: Run Pylint (Static Analysis)
      run: |
        pylint app.py --max-line-length=120 --disable=C0103,C0114,C0115,C0116,R0913,R0914 || echo "::warning::Static analysis issues found."
      continue-on-error: true

  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Check Python syntax
      run: |
        python -m py_compile app.py
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Validate requirements.txt
      run: |
        pip check

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install safety
      run: |
        python -m pip install --upgrade pip
        pip install safety
        
    - name: Run safety check
      run: |
        pip install -r requirements.txt
        safety check --json
      continue-on-error: true

  test-build:
    name: Test Application Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Test Streamlit app imports
      run: |
        python -c "import streamlit; import app; print('App imports successfully')"
        
    - name: Validate file structure
      run: |
        test -f app.py || exit 1
        test -f requirements.txt || exit 1
        test -d assets || exit 1
        test -d styles || exit 1
        test -d .streamlit || exit 1
        echo "All required files and directories present"

  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [code-quality, syntax-check, security-scan, test-build]
    if: always()
    
    steps:
    - name: Check if all jobs succeeded
      run: |
        if [ "${{ needs.code-quality.result }}" != "success" ] || \
           [ "${{ needs.syntax-check.result }}" != "success" ] || \
           [ "${{ needs.security-scan.result }}" != "success" ] || \
           [ "${{ needs.test-build.result }}" != "success" ]; then
          echo "::error::One or more checks failed"
          exit 1
        fi
        echo "âœ… All checks passed successfully!"
